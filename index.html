<!DOCTYPE html>
<html lang="zh-Hant-TW ">
  <head>
    <meta charset="UTF-8" />
    <title>One word for one thousand</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="letters flex-container">
      <div><h1 class="score">0</h1></div>
      <div><button class="button button-next">Next</button></div>
      <div data-letter="65" class="letters flex-container-test">
        <div
          data-letter="65"
          data-answer=""
          class="letter flex-container-test-input"
          tabindex="1"
          onclick="checked(event)"
        ></div>
        <div
          data-letter="65"
          data-answer=""
          class="letter flex-container-test-input"
          tabindex="2"
          onclick="checked(event)"
        ></div>
      </div>
      <div data-letter="65" class="letter flex-container-test-other"></div>
      <div data-letter="65" class="letter flex-container-test-other"></div>
      <div data-letter="65" class="letter flex-container-test-other"></div>
    </div>
    <canvas id="canvas" width="200" height="100" class="canvas"> </canvas>
  </body>
  <script>
    const data = [
      [["乘", "成"], "龍", "快", "婿"],
      [["望", "忘"], "子", "成", "龍"],
      [["言", "鹽"], "多", "必", "失"],
    ];

    const problem = data[Math.floor(Math.random() * data.length)];
    const correctAnswer = problem[0][0];
    const testInputs = document.querySelectorAll(".flex-container-test-input");
    const testOthers = document.querySelectorAll(".flex-container-test-other");
    const scoreText = document.querySelector(".score");
    var score = Number(scoreText.textContent.trim());
    const buttonNext = document.querySelector(".button-next");
    var result = 0;

    // Initiate the game
    function generateQuestion(problem) {
      for (i = 0; i < testInputs.length; i++) {
        testInputs[i].textContent = problem[0][i];
      }

      for (i = 0; i < testOthers.length; i++) {
        testOthers[i].textContent = problem[i + 1];
      }
    }

    generateQuestion(problem);

    // functions for color changes and updating scores

    /*
    The function 'clear' changes the bg color of both inputs to white when clicked.
    The function 'checked'  compares the user's choice with the correct answer and return the result.
    The function 'revealAnswer' changes the input color according to the result.
    The funciton 'updateScore' updates the score.
    */

    function clear(Inputs) {
      for (var i = 0; i < Inputs.length; i++) {
        var item = Inputs[i];
        item.style.backgroundColor = "white";
      }
    }

    function checked(e) {
      e = e;
      var target = e.target;
      clear(testInputs);
      target.style.backgroundColor = "#0eb2ff";
      if (target.textContent.trim() === correctAnswer) {
        target.dataset.answer = 1;
        return (result = 1);
      } else {
        target.dataset.answer = -1;
        return (result = -1);
      }
    }

    function revealAnswer(item) {
      if (item.dataset.answer === "1") {
        console.log("right answer");
        item.style.backgroundColor = "green";
      } else if (item.dataset.answer === "-1") {
        console.log("wrong answer");
        item.style.backgroundColor = "red";
      } else {
        return;
      }
    }

    function updateScore(e) {
      testInputs.forEach((item) => revealAnswer(item));
      score += result;
      scoreText.textContent = score.toString();
      setTimeout(function () {
        location.reload();
      }, 3000);
    }

    buttonNext.addEventListener("click", updateScore);

    // functions for timer
    function drawCircle() {
      var ctx = c.getContext("2d");
      ctx.beginPath();
      ctx.arc(95, 50, 40, 0, 2 * Math.PI);
      ctx.stroke();
    }

    function drawText(text) {
      var ctx = c.getContext("2d");
      ctx.font = c.height / 4 + "px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgb(0, 0, 0)";

      ctx.fillText(text, 95, 50);
    }

    function cleanText() {
      var ctx = c.getContext("2d");
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.clearRect(0, 0, c.width, c.height);
    }

    function getTotalSecond() {
      const Time = new Date();
      const TimeTotalSec =
        Time.getHours() * 3600 + Time.getMinutes() * 60 + Time.getSeconds();
      return TimeTotalSec;
    }

    function updateText(startTimeSec) {
      cleanText();
      drawCircle();

      const currentTimeSec = getTotalSecond();

      const timeLapsed = currentTimeSec - startTimeSec;
      const timeUpdated = 46 - timeLapsed;
      if (timeUpdated === 0) {
        clearInterval(timer);
        console.log("stop!");
      }

      var ctx = c.getContext("2d");
      ctx.font = c.height / 4 + "px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "rgb(0, 0, 0)";
      ctx.fillText(timeUpdated, 95, 50);
    }

    const c = document.getElementById("canvas");
    let isCount = false;

    drawCircle();
    c.addEventListener("mousedown", (e) => {
      if (isCount) return; // stop count down if it is already started
      drawText("45");
      isCount = true;

      const startTimeSec = getTotalSecond();
      cleanText();
      drawCircle();

      timer = setInterval(updateText, 1000, startTimeSec);
      isCount = false;
    });
  </script>
</html>
